---
output:
  md_document  
---
# Setup The Environment

## Load The Required Packages

```{r}
library(tidyverse)
library(ggplot2)
library(caret)
library(randomForest)
library(lfe)
library(grf)
library(cowplot)
source("helpers.r")
```

# Prepare Endline1 Dataset

```{r}
endline1 <- load_endline1()
str(endline1)
```

# Business Index

## Prepare The Dataset

```{r}
target_index <- "biz_index_all_1"

endline1_biz <- endline1 %>%
  filter(total_biz_1 != 0) %>%
  select(everything(),
         -hhid,
         -contains("biz"),
         -anyloan_1,
         -anyloan_amt_1,
         -contains("index"), # prevent confounding
         target_index)       # add target index

endline1_biz_noexp <- endline1 %>%
  filter(total_biz_1 != 0) %>%
  select(everything(),
         -hhid,
         -contains("biz"),
         -anyloan_1,
         -anyloan_amt_1,
         -contains("exp"),   # prevent confounding
         -contains("index"), # prevent confounding
         target_index)       # add target index
```

## Treatment & Target Variable

- Treatment Variable:  `treatment`
- Target Variable: `biz_index_all_1`

We want to find out whether there are heterogeneous effects of  "availibility of Spandana microcredit loan" on business in the area.

```{r}
endline1_biz %>%
  group_by(treatment) %>%
  summarize("Num. of Obs." = n(),
            "Ave. Biz. Index" = mean(biz_index_all_1, na.rm = TRUE))
```

## TMA

### Results

```{r}
source("helpers.r")
num.iters <- 10
tm_gates_biz <- tm_gates("biz_index_all_1", "treatment", endline1_biz,
                         split_ratio = 0.5,
                         cluster="areaid", num.iter=num.iters, ml_method="rf")
```

### GATES

```{r}
alpha <- 0.05
groups <- 5
gates_plot_data <- data.frame(matrix(NA, ncol = 4, nrow = groups))
gates_plot_data[, 1] <- c("1", "2", "3", "4", "5")
for (i in 1:5) {
  gates_plot_data[i, 2] <- median(tm_gates_biz[[1]][, i])
  gates_plot_data[i, 3] <- median(tm_gates_biz[[1]][, i+5])
  gates_plot_data[i, 4] <- median(tm_gates_biz[[1]][, i+10])
}
colnames(gates_plot_data) <- c("G", "F", "U", "L")
```

```{r}
bp_plot_data <- data.frame(matrix(NA, ncol = 4, nrow = 10))
bp_plot_data[,1] <- c(-Inf, Inf)
for (i in 1:3) {
  bp_plot_data[,i+1] <- median(tm_gates_biz[[2]][, i])
}
colnames(bp_plot_data) <- c("x", "ATE", "L", "U")
```

```{r}
ggplot() + 
  theme_gray(base_size = 14) +
  geom_point(data=gates_plot_data,
             aes(y = F, x = G, colour='GATES'),
             size = 3) +
  geom_errorbar(data=gates_plot_data,
                aes(ymax = U, ymin = L ,
                    x = G, width=0.7, colour="90% CB(GATES)"),
                show.legend = TRUE) +
  geom_line(aes(x = x, y = ATE, 
                linetype = cutoff, 
                colour='ATE'), 
            bp_plot_data, 
            linetype = 2) +
  geom_line(aes(x = x, y = U, 
                linetype = cutoff, 
                colour='90% CB(ATE)'), 
            bp_plot_data, 
            linetype = 2) +
  geom_line(aes(x = x, y = L, 
                linetype = cutoff), 
            bp_plot_data, 
            linetype = 2,
            color = "red") +
  scale_colour_manual(values = c("red", "black", "blue", "black"),
                      breaks=c('ATE','90% CB(ATE)',"GATES",'90% CB(GATES)'),
                      guide = guide_legend(override.aes = list(
                        linetype = c("dashed", "dashed"  ,"blank", "solid"),
                        shape = c(NA,NA, 16, NA)), 
                        ncol =2,
                        byrow=TRUE)) +
  theme(plot.title = element_text(hjust = 0.5,size = 11, face = "bold"),
        axis.title=element_text(size=10), 
        legend.text=element_text(size=7), 
        legend.key = element_rect(colour = NA, fill = NA), 
        legend.key.size = unit(1, 'lines'),
        legend.title=element_blank(),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.background=element_rect(fill=alpha('blue', 0)))  +
  ylim(range(-0.3, 0.5)) +
  labs(title="GATES with Random Forest on Business Index", 
       y = "Treatment Effect", x = "Group")
```

### Variable Importance

```{r}
set.seed(111)
main <- tm_gates_biz[[3]]
tm_rf_biz <- randomForest(cte ~ . -treatment-areaid-baseline-G1-G2-G3-G4-G5-biz_index_all_1-prop_score-treat_group-prop_offset-weight-cte_ort-treatment_ort,
                          data = main,
                          ntree = 3000,
                          mtry = 3,
                          replace = TRUE,
                          type="regression")

varImpPlot(tm_rf_biz, n.var = 20, main="TMA Variable Importance")
```

### Prepare For The Plots

```{r}
tm_rf_biz_names <- c("Health Expenditure (mo/pc)",
                     "Temptation Expenditure (mo/pc)",
                     "Household Size (adjusted)",
                     "Amount of Bank Loan")

tm_rf_biz_pred <- predict(tm_rf_biz, newdata=main)
main[, "preds"] <- tm_rf_biz_pred
```

### Trend Plots

```{r}
tm_trend_plots(tm_rf_biz, main, tm_rf_biz_names)
```

### PDP

```{r}
tm_pdp_tmp <- function(model, data, target_var, x_lab) {
  pdp_rf_biz <- partial(model, pred.var = target_var,
                        chull = TRUE, progress = "text", train = data)

  pdp <- ggplot() +
    theme_gray(base_size = 14) +
    geom_line(data = pdp_rf_biz, aes_string(x=target_var, y="yhat")) +
    theme(plot.title = element_text(hjust = 0.5,size = 14, face = "bold"),
          axis.title=element_text(size=14),
          axis.text=element_text(size=14)) +
    scale_x_continuous(labels = scales::comma) +
    labs(#title="PDP Of Two-models Approach",
      x=x_lab, y="pred. CTE")
  return(pdp)
}


tm_pdp_tmp(tm_rf_biz, main, "nondurable_exp_mo_pc_1", "Nondurable Expenditure (mo/pc)")
tm_pdp_tmp(tm_rf_biz, main, "durables_exp_mo_pc_1", "Durables Expenditure (mo/pc)")
#tm_pdp_plots(tm_rf_biz, main, tm_rf_biz_names)
```

### Transformed Outcome Loss

```{r}
# transformed outcome : 
main$biz_index_transformed <- (main$treatment - main$prop_score) / main$prop_score*(1 - main$prop_score) * main$biz_index_all_1

# transformed outcome loss : 
biz_loss <- sum((main$pred_cte - main$biz_index_transformed)^2) / nrow(main)
biz_loss
```

## TMA w/o Expenditure

### Results

```{r}
source("helpers.r")
num.iters <- 10
tm_gates_biz_noexp <- tm_gates("biz_index_all_1", "treatment", endline1_biz_noexp,
                               split_ratio = 0.5,
                               cluster="areaid", num.iter = num.iters, ml_method = "rf")
```

### GATES

```{r}
alpha <- 0.05
groups <- 5
gates_plot_biz_noexp <- data.frame(matrix(NA, ncol = 4, nrow = groups))
gates_plot_biz_noexp[, 1] <- c("1", "2", "3", "4", "5")
for (i in 1:5) {
  gates_plot_biz_noexp[i, 2] <- median(tm_gates_biz_noexp[[1]][, i])
  gates_plot_biz_noexp[i, 3] <- median(tm_gates_biz_noexp[[1]][, i+5])
  gates_plot_biz_noexp[i, 4] <- median(tm_gates_biz_noexp[[1]][, i+10])
}
colnames(gates_plot_biz_noexp) <- c("G", "F", "U", "L")
```

```{r}
bp_plot_biz_noexp <- data.frame(matrix(NA, ncol = 4, nrow = 10))
bp_plot_biz_noexp[,1] <- c(-Inf, Inf)
for (i in 1:3) {
  bp_plot_biz_noexp[,i+1] <- median(tm_gates_biz_noexp[[2]][, i])
}
colnames(bp_plot_biz_noexp) <- c("x", "ATE", "L", "U")
```

```{r}
ggplot() + 
  theme_gray(base_size = 14) +
  geom_point(data=gates_plot_biz_noexp,
             aes(y = F, x = G, colour='GATES'),
             size = 3) +
  geom_errorbar(data=gates_plot_biz_noexp,
                aes(ymax = U, ymin = L ,
                    x = G, width=0.7, colour="90% CB(GATES)"),
                show.legend = TRUE) +
  geom_line(aes(x = x, y = ATE, 
                linetype = cutoff, 
                colour='ATE'), 
            bp_plot_biz_noexp, 
            linetype = 2) +
  geom_line(aes(x = x, y = U, 
                linetype = cutoff, 
                colour='90% CB(ATE)'), 
            bp_plot_biz_noexp, 
            linetype = 2) +
  geom_line(aes(x = x, y = L, 
                linetype = cutoff), 
            bp_plot_biz_noexp, 
            linetype = 2,
            color = "red") +
  scale_colour_manual(values = c("red", "black", "blue", "black"),
                      breaks=c('ATE','90% CB(ATE)',"GATES",'90% CB(GATES)'),
                      guide = guide_legend(override.aes = list(
                        linetype = c("dashed", "dashed"  ,"blank", "solid"),
                        shape = c(NA,NA, 16, NA)), 
                        ncol =2,
                        byrow=TRUE)) +
  theme(plot.title = element_text(hjust = 0.5,size = 11, face = "bold"),
        axis.title=element_text(size=10), 
        legend.text=element_text(size=7), 
        legend.key = element_rect(colour = NA, fill = NA), 
        legend.key.size = unit(1, 'lines'),
        legend.title=element_blank(),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.background=element_rect(fill=alpha('blue', 0)))  +
  ylim(range(-0.3, 0.5)) +
  labs(title="GATES with Random Forest on Business Index", 
       y = "Treatment Effect", x = "Group by Het Score")
```

### Variable Importance

```{r}
set.seed(111)
main <- tm_gates_biz_noexp[[3]]
tm_rf_biz_noexp <- randomForest(cte ~ . -treatment-areaid-baseline-G1-G2-G3-G4-G5-biz_index_all_1-prop_score-treat_group-prop_offset-weight-cte_ort-treatment_ort,
                          data = main,
                          ntree = 3000,
                          mtry = 3,
                          replace = TRUE,
                          type="regression")

varImpPlot(tm_rf_biz_noexp, n.var = 20, main="TMA Variable Importance")
```

### Prepare For The Plots

```{r}
tm_rf_biz_noexp_names <- c("Amount of Bank Loan",
                           "Household Size (adjusted)",
                           "Amount of Informal Loan",
                           "Age of Household Head")

tm_rf_biz_noexp_pred <- predict(tm_rf_biz_noexp, newdata=main)
main[, "preds"] <- tm_rf_biz_noexp_pred
```

### Trend Plots

```{r}
tm_trend_plots(tm_rf_biz_noexp, main, tm_rf_biz_noexp_names)
```

### PDP

```{r}
tm_pdp_plots(tm_rf_biz_noexp, main, tm_rf_biz_noexp_names)
```

### Transformed Outcome Loss
```{r}
# transformed outcome : 
main$biz_index_transformed <- (main$treatment - main$prop_score) / main$prop_score*(1 - main$prop_score) * main$biz_index_all_1

# transformed outcome loss : 
biz_loss <- sum((main$cte - main$biz_index_transformed)^2) / nrow(main)
biz_loss
```

# Women Empowerment Index

## Prepare The Dataset

```{r}
target_index <- "women_emp_index_1"

endline1_woemp <- endline1 %>%
  select(everything(),
         -hhid,
         -contains("index"), # prevent confounding
         -anyloan_1,
         -anyloan_amt_1,
         target_index)       # add target index

endline1_woemp_noexp <- endline1 %>%
  select(everything(),
         -hhid,
         -contains("exp"),
         -contains("index"), # prevent confounding
         -anyloan_1,
         -anyloan_amt_1,
         target_index)       # add target index
```

## TMA

```{r}
source("helpers.r")
num.iters <- 10
tm_gates_woemp <- tm_gates("women_emp_index_1", "treatment", endline1_woemp,
                           split_ratio = 0.5,
                           cluster="areaid", num.iter=num.iters, ml_method="rf")
```

### GATES

```{r}
alpha <- 0.05
groups <- 5
gates_plot_woemp <- data.frame(matrix(NA, ncol = 4, nrow = groups))
gates_plot_woemp[, 1] <- c("1", "2", "3", "4", "5")
for (i in 1:5) {
  gates_plot_woemp[i, 2] <- median(tm_gates_woemp[[1]][, i])
  gates_plot_woemp[i, 3] <- median(tm_gates_woemp[[1]][, i+5])
  gates_plot_woemp[i, 4] <- median(tm_gates_woemp[[1]][, i+10])
}
colnames(gates_plot_woemp) <- c("G", "F", "U", "L")
```

```{r}
bp_plot_woemp <- data.frame(matrix(NA, ncol = 4, nrow = 10))
bp_plot_woemp[,1] <- c(-Inf, Inf)
for (i in 1:3) {
  bp_plot_woemp[,i+1] <- median(tm_gates_woemp[[2]][, i])
}
colnames(bp_plot_woemp) <- c("x", "ATE", "L", "U")
```

```{r}
ggplot() + 
  theme_gray(base_size = 14) +
  geom_point(data=gates_plot_woemp,
             aes(y = F, x = G, colour='GATES'),
             size = 3) +
  geom_errorbar(data=gates_plot_woemp,
                aes(ymax = U, ymin = L ,
                    x = G, width=0.7, colour="90% CB(GATES)"),
                show.legend = TRUE) +
  geom_line(aes(x = x, y = ATE, 
                linetype = cutoff, 
                colour='ATE'), 
            bp_plot_woemp, 
            linetype = 2) +
  geom_line(aes(x = x, y = U, 
                linetype = cutoff, 
                colour='90% CB(ATE)'), 
            bp_plot_woemp, 
            linetype = 2) +
  geom_line(aes(x = x, y = L, 
                linetype = cutoff), 
            bp_plot_woemp, 
            linetype = 2,
            color = "red") +
  scale_colour_manual(values = c("red", "black", "blue", "black"),
                      breaks=c('ATE','90% CB(ATE)',"GATES",'90% CB(GATES)'),
                      guide = guide_legend(override.aes = list(
                        linetype = c("dashed", "dashed"  ,"blank", "solid"),
                        shape = c(NA,NA, 16, NA)), 
                        ncol =2,
                        byrow=TRUE)) +
  theme(plot.title = element_text(hjust = 0.5,size = 11, face = "bold"),
        axis.title=element_text(size=10), 
        legend.text=element_text(size=7), 
        legend.key = element_rect(colour = NA, fill = NA), 
        legend.key.size = unit(1, 'lines'),
        legend.title=element_blank(),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.background=element_rect(fill=alpha('blue', 0)))  +
  ylim(range(-0.3, 0.5)) +
  labs(title="GATES with Random Forest on Women Empowerment Index", 
       y = "Treatment Effect", x = "Group by Het Score")
```

### Variable Importance

```{r}
set.seed(111)
main <- tm_gates_woemp[[3]]
tm_rf_woemp <- randomForest(cte ~ . -treatment-areaid-baseline-G1-G2-G3-G4-G5-women_emp_index_1-prop_score-treat_group-prop_offset-weight-cte_ort-treatment_ort,
                          data = main,
                          ntree = 3000,
                          mtry = 3,
                          replace = TRUE,
                          type="regression")

varImpPlot(tm_rf_woemp, n.var = 20, main="TMA Variable Importance")
```

### Prepare For The Plots

```{r}
tm_rf_woemp_names <- c("Household Size (adjusted)",
                       "Temptation Expenditure (mo/pc)",
                       "Nondurable Expenditure (mo/pc)",
                       "Num. Adults")

tm_rf_woemp_pred <- predict(tm_rf_woemp, newdata=main)
main[, "preds"] <- tm_rf_woemp_pred
```

### Trend Plots

```{r}
tm_trend_plots(tm_rf_woemp, main, tm_rf_woemp_names)
```

### PDP

```{r}
tm_pdp_plots(tm_rf_woemp, main, tm_rf_woemp_names)
```

### Transformed Outcome Loss
```{r}
# transformed outcome : 
main$woemp_index_transformed <- (main$treatment - main$prop_score) / main$prop_score*(1 - main$prop_score) * main$women_emp_index_1

# transformed outcome loss : 
woemp_loss <- sum((main$preds - main$woemp_index_transformed)^2) / nrow(main)
woemp_loss
```

## TMA w/o Expenditure

```{r}
source("helpers.r")
num.iters <- 10
tm_gates_woemp_noexp <- tm_gates("women_emp_index_1", "treatment", endline1_woemp_noexp,
                                 split_ratio = 0.5,
                                 cluster="areaid", num.iter=num.iters, ml_method="rf")
```

### GATES

```{r}
alpha <- 0.05
groups <- 5
gates_plot_woemp <- data.frame(matrix(NA, ncol = 4, nrow = groups))
gates_plot_woemp[, 1] <- c("1", "2", "3", "4", "5")
for (i in 1:5) {
  gates_plot_woemp[i, 2] <- median(tm_gates_woemp_noexp[[1]][, i])
  gates_plot_woemp[i, 3] <- median(tm_gates_woemp_noexp[[1]][, i+5])
  gates_plot_woemp[i, 4] <- median(tm_gates_woemp_noexp[[1]][, i+10])
}
colnames(gates_plot_woemp) <- c("G", "F", "U", "L")
```

```{r}
bp_plot_woemp <- data.frame(matrix(NA, ncol = 4, nrow = 10))
bp_plot_woemp[,1] <- c(-Inf, Inf)
for (i in 1:3) {
  bp_plot_woemp[,i+1] <- median(tm_gates_woemp_noexp[[2]][, i])
}
colnames(bp_plot_woemp) <- c("x", "ATE", "L", "U")
```

```{r}
ggplot() + 
  theme_gray(base_size = 14) +
  geom_point(data=gates_plot_woemp,
             aes(y = F, x = G, colour='GATES'),
             size = 3) +
  geom_errorbar(data=gates_plot_woemp,
                aes(ymax = U, ymin = L ,
                    x = G, width=0.7, colour="90% CB(GATES)"),
                show.legend = TRUE) +
  geom_line(aes(x = x, y = ATE, 
                linetype = cutoff, 
                colour='ATE'), 
            bp_plot_woemp, 
            linetype = 2) +
  geom_line(aes(x = x, y = U, 
                linetype = cutoff, 
                colour='90% CB(ATE)'), 
            bp_plot_woemp, 
            linetype = 2) +
  geom_line(aes(x = x, y = L, 
                linetype = cutoff), 
            bp_plot_woemp, 
            linetype = 2,
            color = "red") +
  scale_colour_manual(values = c("red", "black", "blue", "black"),
                      breaks=c('ATE','90% CB(ATE)',"GATES",'90% CB(GATES)'),
                      guide = guide_legend(override.aes = list(
                        linetype = c("dashed", "dashed"  ,"blank", "solid"),
                        shape = c(NA,NA, 16, NA)), 
                        ncol =2,
                        byrow=TRUE)) +
  theme(plot.title = element_text(hjust = 0.5,size = 11, face = "bold"),
        axis.title=element_text(size=10), 
        legend.text=element_text(size=7), 
        legend.key = element_rect(colour = NA, fill = NA), 
        legend.key.size = unit(1, 'lines'),
        legend.title=element_blank(),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.background=element_rect(fill=alpha('blue', 0)))  +
  ylim(range(-0.3, 0.5)) +
  labs(title="GATES with Random Forest on Women Empowerment Index", 
       y = "Treatment Effect", x = "Group by Het Score")
```

### Variable Importance

```{r}
set.seed(111)
main <- tm_gates_woemp_noexp[[3]]
tm_rf_woemp_noexp <- randomForest(cte ~ . -treatment-areaid-baseline-G1-G2-G3-G4-G5-women_emp_index_1-prop_score-treat_group-prop_offset-weight-cte_ort-treatment_ort,
                          data = main,
                          ntree = 3000,
                          mtry = 3,
                          replace = TRUE,
                          type="regression")

varImpPlot(tm_rf_woemp_noexp, n.var = 20, main="TMA Variable Importance")
```

### Prepare For The Plots

```{r}
tm_rf_woemp_noexp_names <- c("Household Size (adjusted)",
                             "Num. Adults",
                             "Head Age",
                             "Hours Of Work (Outside)")

tm_rf_woemp_noexp_pred <- predict(tm_rf_woemp_noexp, newdata=main)
main[, "preds"] <- tm_rf_woemp_noexp_pred
```

### Trend Plots

```{r}
tm_trend_plots(tm_rf_woemp_noexp, main, tm_rf_woemp_noexp_names)
```

### PDP

```{r}
tm_pdp_plots(tm_rf_woemp_noexp, main, tm_rf_woemp_noexp_names)
```

### Transformed Outcome Loss
```{r}
# transformed outcome : 
main$woemp_index_transformed <- (main$treatment - main$prop_score) / main$prop_score*(1 - main$prop_score) * main$women_emp_index_1

# transformed outcome loss : 
woemp_loss <- sum((main$cte - main$woemp_index_transformed)^2) / nrow(main)
woemp_loss
```

# CAUSAL FOREST

## Business Index

```{r}
target_index <- "biz_index_all_1"

# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_biz$treatment, p = 0.70, list = FALSE) 
train <- endline1_biz[idx.train, ] # training set
test <-  endline1_biz[-idx.train, ]

# train data
Y <- train$biz_index_all_1
X <- train %>% 
  select(-treatment, -target_index, -areaid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE,
  seed = 234)
```

```{r}
var_imp_plot(forest)
```

```{r}
# test data
test_Y <- test$biz_index_all_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions
trend_plots(forest, test)
```

```{r}
target_var <- "informal_amt_1"
pdp_title <- "Informal Loan Amount"
crf_pdp <- partial(forest, pred.var = target_var, 
                   chull = TRUE, progress = "text",
                   train = model.matrix(~., data = X))

pdp <- ggplot() +
  theme_gray(base_size = 14) +
  geom_line(data = crf_pdp, aes_string(x=target_var, y="yhat")) +
  theme(plot.title = element_text(hjust = 0.5,size = 11, face = "bold"),
        axis.title=element_text(size=14), 
        legend.text=element_text(size=7), 
        legend.key = element_rect(colour = NA, fill = NA), 
        legend.key.size = unit(1, 'lines'),
        legend.title=element_blank(),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.background=element_rect(fill=alpha('blue', 0))) +
  labs(x=pdp_title, y="Conditional Treatment Effect")
pdp
```
```{r}

```

### Qini Score of Causal Random Forset

```{r}
target_index <- "biz_index_all_1"

# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_biz_bin$treatment, p = 0.70, list = FALSE) 
train <- endline1_biz[idx.train, ] # training set
test <-  endline1_biz[-idx.train, ]

# train data
Y <- train$biz_index_all_1
X <- train %>% 
  select(-treatment, -target_index, -areaid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE,
  seed = 234)
```

```{r}
# test data
test_Y <- test$biz_index_all_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions

QiniCurve(QiniTable(test, "treatment", "biz_index_all_1", "preds"))
```



```{r}
# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_biz_bin$treatment, p = 0.75, list = FALSE) 
train <- endline1_biz_bin[idx.train, ] # training set
test <-  endline1_biz_bin[-idx.train, ]

# train data
Y <- train$biz_index_all_1
X <- train %>% 
  select(-treatment, -target_index, -areaid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE)

var_imp_plot(forest)

# test data
test_Y <- test$biz_index_all_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions
trend_plots(forest, test)
```

```{r}
tm_gates_biz_bin[[7]]$cte <- 1 - tm_gates_biz_bin[[7]]$cte
```


```{r}
tm_qini_table <- QiniTable(tm_gates_biz_bin[[7]], "treatment", "biz_index_all_1", "cte")
crf_qini_table <- QiniTable(test, "treatment", "biz_index_all_1", "preds")
qini_plot_data <- data.frame(matrix(NA, ncol = 4, nrow = 11))
colnames(qini_plot_data) <- c("tm_X","tm_Y", "crf_X", "crf_Y")
qini_plot_data$tm_X <- c(0, tm_qini_table[, 3])/tm_qini_table[nrow(tm_qini_table), 3]*100
qini_plot_data$tm_Y <- c(0, tm_qini_table[, 7])
qini_plot_data$crf_X <- c(0, crf_qini_table[, 3])/crf_qini_table[nrow(crf_qini_table), 3]*100
qini_plot_data$crf_Y <- c(0, crf_qini_table[, 7])
```
```{r}
ggplot(qini_plot_data) + 
  geom_line(aes(x=tm_X, y=tm_Y, color = "red")) +
  geom_line(aes(x=crf_X, y=crf_Y, color = "darkblue")) +
  scale_color_discrete(name = "Methods", labels = c("Two-model", "Causal RF")) +
  labs(x="Proportion of Population Targeted (%)",
       y="Incremental Uplift (%)") +
  ylim(-10, 10)
```


```{r}
test <- cbind(test, preds)

table
QiniCurve(table)
```

```{r}
target_index <- "biz_index_all_1"

endline1_biz <- endline1[1:15]
biz_index_all_1 <- endline1$biz_index_all_1
endline1_biz <- cbind(endline1_biz, biz_index_all_1)


# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_biz$treatment, p = 0.75, list = FALSE) 
train <- endline1_biz[idx.train, ] # training set
test <-  endline1_biz[-idx.train, ]

# train data
Y <- train$biz_index_all_1
X <- train %>% 
  select(-treatment, -target_index, -areaid, -hhid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE)

var_imp_plot(forest)

# test data
test_Y <- test$biz_index_all_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions
trend_plots(forest, test)
```

```{r}
QiniCurve(QiniTable(test, "treatment", "biz_index_all_1", "preds"))
```

### Re-run The Model With Only Important Variables

```{r}
Y.forest = regression_forest(X, Y, clusters = X.clusters)
Y.hat = predict(Y.forest)$predictions
W.forest = regression_forest(X, W, clusters = X.clusters)
W.hat = predict(W.forest)$predictions

cf.raw = causal_forest(X, Y, W,
                       Y.hat = Y.hat, W.hat = W.hat,
                       clusters = X.clusters)

varimp = variable_importance(cf.raw)
selected.idx = which(varimp > mean(varimp))

cf = causal_forest(X[,selected.idx], Y, W,
                   Y.hat = Y.hat, W.hat = W.hat,
                   clusters = X.clusters,
                   samples_per_cluster = 10,
                   tune.parameters = TRUE)

tau.hat = predict(cf)$predictions
```

### Confidence Interval for Average Treatment Effects

```{r}
high_effect = tau.hat > median(tau.hat)
ate.high = average_treatment_effect(cf, subset = high_effect) 
ate.low = average_treatment_effect(cf, subset = !high_effect) 

paste("95% CI for difference in ATE:",
round(ate.high[1] - ate.low[1], 3), "+/-",
round(qnorm(0.975) * sqrt(ate.high[2]^2 + ate.low[2]^2), 3))
```

### Best Linear Predictor

```{r}
test_calibration(cf)
```
Heterogeneity with 0.1 significance.

### The Effects of `hours_week_biz_1` and `total_exp_mo_pc_1`

```{r}
area.mat = model.matrix(~ -1 + areaid, data = train)
area.size = colSums(area.mat)

dr.score = tau.hat + W / cf$W.hat * (Y - cf$Y.hat - (1 - cf$W.hat) * tau.hat) -
  (1 - W) / (1 - cf$W.hat) * (Y - cf$Y.hat + cf$W.hat * tau.hat)

area.score = area.mat * dr.score / area.size
```


```{r}
area.hours_biz = area.mat * X$hours_week_biz_1/ area.size
high_hours_biz = area.hours_biz > median(area.hours_biz) 
t.test(area.score[high_hours_biz], area.score[!high_hours_biz])
```


```{r}
area.total_exp = area.mat * X$total_exp_mo_pc_1 / area.size
high_total_exp = area.total_exp > median(area.total_exp) 
t.test(area.score[high_total_exp], area.score[!high_total_exp])
```

```{r}
area.food_exp = area.mat * X$food_exp_mo_pc_1 / area.size
high.food_exp = area.food_exp > median(area.food_exp) 
t.test(area.score[high.food_exp], area.score[!high.food_exp]) 
```
There is heterogeneity along `hours_week_biz_1` and `total_exp_mo_pc_1` with 0.05 significance.



## Credit Index
```{r}
target_index <- "credit_index_1"

endline1_credit <- endline1 %>%
  select(everything(),
         -hhid,
         -spandana_1,
         -othermfi_1,
         -anybank_1,
         -anyinformal_1,
         -anyloan_1,
         -contains("amt"),
         -contains("index"), # prevent confounding
         target_index)       # add target index
str(endline1_credit)

endline1_biz$biz_index_all_1 <- ifelse(endline1_biz$biz_index_all_1<0, 0, 1)

# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_credit$treatment, p = 0.75, list = FALSE) 
train <- endline1_credit[idx.train, ] # training set
test <-  endline1_credit[-idx.train, ]

# train data
Y <- train$credit_index_1
X <- train %>% 
  select(-treatment, -target_index, -areaid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE)

var_imp_plot(forest)

# test data
test_Y <- test$credit_index_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions
trend_plots(forest, test)
```

```{r}
test <- cbind(test, preds)
table <- QiniTable(test, "treatment", "credit_index_all_1", "predictions")
table
QiniCurve(table)
```

```{r}
Y.forest = regression_forest(X, Y, clusters = X.clusters)
Y.hat = predict(Y.forest)$predictions
W.forest = regression_forest(X, W, clusters = X.clusters)
W.hat = predict(W.forest)$predictions

cf.raw = causal_forest(X, Y, W,
                       Y.hat = Y.hat, W.hat = W.hat,
                       clusters = X.clusters)

varimp = variable_importance(cf.raw)
selected.idx = which(varimp > mean(varimp))

cf = causal_forest(X[,selected.idx], Y, W,
                   Y.hat = Y.hat, W.hat = W.hat,
                   clusters = X.clusters,
                   samples_per_cluster = 10,
                   tune.parameters = TRUE)

tau.hat = predict(cf)$predictions
```

### Confidence Interval for Average Treatment Effects

```{r}
high_effect = tau.hat > median(tau.hat)
ate.high = average_treatment_effect(cf, subset = high_effect) 
ate.low = average_treatment_effect(cf, subset = !high_effect) 

paste("95% CI for difference in ATE:",
round(ate.high[1] - ate.low[1], 3), "+/-",
round(qnorm(0.975) * sqrt(ate.high[2]^2 + ate.low[2]^2), 3))
```

### Best Linear Predictor

```{r}
test_calibration(cf)
```
There is heterogeneity.

### The Effects of `total_exp_mo_pc_1` and `food_exp_mo_pc_1` and `nondurable_exp_mo_pc_1`

```{r}
area.mat = model.matrix(~ -1 + areaid, data = train)
area.size = colSums(area.mat)

dr.score = tau.hat + W / cf$W.hat * (Y - cf$Y.hat - (1 - cf$W.hat) * tau.hat) -
  (1 - W) / (1 - cf$W.hat) * (Y - cf$Y.hat + cf$W.hat * tau.hat)

area.score = area.mat * dr.score / area.size
```

```{r}
area.total_exp = area.mat * X$total_exp_mo_pc_1 / area.size
high_total_exp = area.total_exp > median(area.total_exp) 
t.test(area.score[high_total_exp], area.score[!high_total_exp])
```

The t-test shows no significant of different treatment effects between high food expenditure and 

```{r}
area.food_exp = area.mat * X$food_exp_mo_pc_1 / area.size
high.food_exp = area.food_exp > median(area.food_exp) 
t.test(area.score[high.food_exp], area.score[!high.food_exp]) 
```
```{r}
area.nondurable_exp = area.mat * X$nondurable_exp_mo_pc_1 / area.size
high.nondurable_exp = area.nondurable_exp > median(area.nondurable_exp) 
t.test(area.score[high.nondurable_exp], area.score[!high.nondurable_exp]) 
```
There is heterogeneity along `total_exp_mo_pc_1` and `food_exp_mo_pc_1` and `nondurable_exp_mo_pc_1`.


## Consumption Index
```{r}
target_index <- "consumption_index_1"

endline1_consumption <- endline1 %>%
  select(everything(),
         -hhid,
         -contains("exp"),
         bizexpense_1,
         -contains("index"), # prevent confounding
         target_index)       # add target index
str(endline1_consumption)


# test/train
set.seed(123)
idx.train <- caret::createDataPartition(y = endline1_consumption$treatment, p = 0.75, list = FALSE) 
train <- endline1_consumption[idx.train, ] # training set
test <-  endline1_consumption[-idx.train, ]

# train data
Y <- train$consumption_index_1
X <- train %>% 
  select(-treatment, -target_index, -areaid)
X.clusters <- train$areaid
W <- train$treatment

# model
forest <- causal_forest(
  model.matrix(~., data = X),
  Y,
  W,
  clusters = X.clusters,
  mtry = 3, 
  num.trees = 3000,
  honesty = TRUE)

var_imp_plot(forest)

# test data
test_Y <- test$consumption_index_1
test_X <- test %>% 
  select(-treatment, -target_index, -areaid)
test_clusters <- test$areaid
test_W <- test$treatment

# prediction
preds <- predict(
  object = forest,
  newdata = model.matrix(~ ., data = test_X, estimate.variance = TRUE))
test$preds <- preds$predictions
trend_plots(forest, test)
```




```{r}
Y.forest = regression_forest(X, Y, clusters = X.clusters)
Y.hat = predict(Y.forest)$predictions
W.forest = regression_forest(X, W, clusters = X.clusters)
W.hat = predict(W.forest)$predictions

cf.raw = causal_forest(X, Y, W,
                       Y.hat = Y.hat, W.hat = W.hat,
                       clusters = X.clusters)

varimp = variable_importance(cf.raw)
selected.idx = which(varimp > mean(varimp))

cf = causal_forest(X[,selected.idx], Y, W,
                   Y.hat = Y.hat, W.hat = W.hat,
                   clusters = X.clusters,
                   samples_per_cluster = 10,
                   tune.parameters = TRUE)

tau.hat = predict(cf)$predictions
```

### Confidence Interval for Average Treatment Effects

```{r}
high_effect = tau.hat > median(tau.hat)
ate.high = average_treatment_effect(cf, subset = high_effect) 
ate.low = average_treatment_effect(cf, subset = !high_effect) 

paste("95% CI for difference in ATE:",
round(ate.high[1] - ate.low[1], 3), "+/-",
round(qnorm(0.975) * sqrt(ate.high[2]^2 + ate.low[2]^2), 3))
```

### Best Linear Predictor

```{r}
test_calibration(cf)
```
No heterogeneity. 

### The Effects of `anyloan_amt_1` and `hhsize_adj_1`

```{r}
area.mat = model.matrix(~ -1 + areaid, data = train)
area.size = colSums(area.mat)

dr.score = tau.hat + W / cf$W.hat * (Y - cf$Y.hat - (1 - cf$W.hat) * tau.hat) -
  (1 - W) / (1 - cf$W.hat) * (Y - cf$Y.hat + cf$W.hat * tau.hat)

area.score = area.mat * dr.score / area.size
```

```{r}
area.anyloan_amt = area.mat * X$anyloan_amt_1 / area.size
high_anyloan_amt = area.anyloan_amt > median(area.anyloan_amt) 
t.test(area.score[high_anyloan_amt], area.score[!high_anyloan_amt])
```

```{r}
area.hhsize_adj = area.mat * X$hhsize_adj_1 / area.size
high.hhsize_adj = area.hhsize_adj > median(area.hhsize_adj) 
t.test(area.score[high.hhsize_adj], area.score[!high.hhsize_adj]) 
```
No heterogeneity along `anyloan_amt_1` and `hhsize_adj_1`. 
